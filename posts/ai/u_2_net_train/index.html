<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        :root {
            --accent-color: #FF4D4D;
        }
    </style>

    
    
    
    
    
    

    
    <title>U-2-Net 进行积水区域分割</title>
    <meta name="description" content="只因你太美">
    <meta name="keywords" content='blog, xhikun, hugo, 深度学习'>

    <meta property="og:url" content="https://blog.wjxuikun.eu.org/posts/ai/u_2_net_train/">
    <meta property="og:type" content="website">
    <meta property="og:title" content="U-2-Net 进行积水区域分割">
    <meta property="og:description" content="只因你太美">
    <meta property="og:image" content="https://blog.wjxuikun.eu.org/images/avatar.jpg">
    <meta property="og:image:secure_url" content="https://blog.wjxuikun.eu.org/images/avatar.jpg">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="U-2-Net 进行积水区域分割">
    <meta name="twitter:description" content="只因你太美">
    <meta property="twitter:domain" content="https://blog.wjxuikun.eu.org/posts/ai/u_2_net_train/">
    <meta property="twitter:url" content="https://blog.wjxuikun.eu.org/posts/ai/u_2_net_train/">
    <meta name="twitter:image" content="https://blog.wjxuikun.eu.org/images/avatar.jpg">

    
    <link rel="canonical" href="https://blog.wjxuikun.eu.org/posts/ai/u_2_net_train/" />

    
    <link rel="stylesheet" type="text/css" href="/css/normalize.min.css" media="print">

    
    <link rel="stylesheet" type="text/css" href="/css/main.min.css">

    
    <link id="dark-theme" rel="stylesheet" href="/css/dark.min.css">

    
    <script src="/js/bundle.min.edd985581bf860dfb4507e5885197f1680160c7fe19f23b31e183126d99dd596.js" integrity="sha256-7dmFWBv4YN&#43;0UH5YhRl/FoAWDH/hnyOzHhgxJtmd1ZY="></script>

    
    
        <!-- KaTeX -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css" integrity="sha384-Xi8rHCmBmhbuyyhbI88391ZKP2dmfnOl4rT9ZfRI7mLTdk1wblIUnrIq35nqwEvC" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js" integrity="sha384-X/XCfMm41VSsqRNQgDerQczD69XqmjOOOwYQvr/uuC+j4OPoNhVgjdGFwhvN02Ja" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js" integrity="sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR" crossorigin="anonymous"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement(document.body, {
          // customised options
          // • auto-render specific keys, e.g.:
          delimiters: [
            {left: '$$', right: '$$', display: true},
            {left: '$', right: '$', display: false},
          ],
          // • rendering keys, e.g.:
          throwOnError : false
        });
      });
    </script>
  
    
</head>
<body>
        <script type="text/javascript">
            
            setThemeByUserPref();
        </script><header class="header">
    <nav class="header-nav">

        
        <div class="avatar">
            <a href="https://blog.wjxuikun.eu.org/">
                <img src="https://blog.wjxuikun.eu.org//images/avatar.jpg" alt="avatar" />
            </a>
        </div>
        

        <div class="nav-title">
            <a class="nav-brand" href="https://blog.wjxuikun.eu.org/">xhikun</a>
        </div>

        <div class="nav-links">
            
            <div class="nav-link">
                <a href="https://blog.wjxuikun.eu.org/"><span data-feather='home'></span> Home </a>
            </div>
            
            <div class="nav-link">
                <a href="https://blog.wjxuikun.eu.org/posts/"><span data-feather='book'></span> Posts </a>
            </div>
            
            <div class="nav-link">
                <a href="https://blog.wjxuikun.eu.org/projects/"><span data-feather='code'></span> Projects </a>
            </div>
            
            <div class="nav-link">
                <a href="https://blog.wjxuikun.eu.org/tags/"><span data-feather='tag'></span> Tags </a>
            </div>
            

            <span class="nav-icons-divider"></span>
            <div class="nav-link dark-theme-toggle">
                <span id="dark-theme-toggle-screen-reader-target" class="sr-only"></span>
                <a>
                    <span id="theme-toggle-icon" data-feather="moon"></span>
                </a>
            </div>

            <div class="nav-link" id="hamburger-menu-toggle">
                <span id="hamburger-menu-toggle-screen-reader-target" class="sr-only">menu</span>
                <a>
                    <span data-feather="menu"></span>
                </a>
            </div>

            
            <ul class="nav-hamburger-list visibility-hidden">
                
                <li class="nav-item">
                    <a href="https://blog.wjxuikun.eu.org/"><span data-feather='home'></span> Home </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://blog.wjxuikun.eu.org/posts/"><span data-feather='book'></span> Posts </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://blog.wjxuikun.eu.org/projects/"><span data-feather='code'></span> Projects </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://blog.wjxuikun.eu.org/tags/"><span data-feather='tag'></span> Tags </a>
                </li>
                
                <li class="nav-item dark-theme-toggle">
                    <span id="dark-theme-toggle-screen-reader-target" class="sr-only">theme</span>
                    <a>
                        <span id="theme-toggle-icon" data-feather="moon"></span>
                    </a>
                </li>
            </ul>

        </div>
    </nav>
</header>
<main id="content">
    <div class="post container">
    <div class="post-header-section">
        <h1>U-2-Net 进行积水区域分割</h1>
        <small role="doc-subtitle"></small>
        <p class="post-date">
            August 4, 2023
        </p>

        <ul class="post-tags">
        
            <li class="post-tag"><a href="https://blog.wjxuikun.eu.org/tags/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0">深度学习</a></li>
        
        </ul>
    </div>

    <div class="post-content">
        <p>
            <p>项目需求，需要分割出图片中积水区域，以及简单计算其面积，本次使用U-2-Net训练，并记录结果
U-2-Net官方github上面的pytorch是0.4.0版本，自己本地是1.8.0，起初以为出问题，不过最终训练过程却出奇的顺利</p>
<h1 id="git">Git</h1>
<p><a href="https://github.com/xuebinqin/U-2-Net">官网</a></p>
<h1 id="数据集准备">数据集准备</h1>
<p>训练代码默认使用DUTS数据集，下载后的标签如图
<img src="/images/ai/U_2_Net_train/1.png" alt=""></p>
<p>显著目标检测任务是将图像中的显著区域（前景）与非显著区域（背景）分割开来，结果用黑白图来表示，即前景用像素值255表示，背景用0来表示，一般的到的黑白图是1维的，所以如果要通过端到端来实现，那么模型的最后一个卷积层输出的通道数应该为1。这有点类似于语义分割的二分类任务，但是与语义分割不同的是，显著目标检测没有既定类别的分类对象，而语义分割则是有固定类别的分类任务，显著目标检测无法固定分类数，从结果图上看，显著目标检测（结果图为灰度图）更像是回归任务。</p>
<p>=====</p>
<p>接下来准备自己的标签，我的需求是分割出图片中有水的区域，最开始是使用所有包含积水的图片训练，但这样训练模型会将没有积水的区域也识别有积水，因此我增加了同一场景无积水的图作为负样本
<img src="/images/ai/U_2_Net_train/2.jpg" alt=""></p>
<h1 id="修改代码">修改代码</h1>
<h2 id="第一个错">第一个错</h2>
<p>负样本的标签即全图为背景，值都为0，因此默认的data_loader.py 会报错</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">ValueError</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">At</span> <span style="color:#a6e22e">least</span> <span style="color:#a6e22e">one</span> <span style="color:#a6e22e">stride</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">the</span> <span style="color:#a6e22e">given</span> <span style="color:#a6e22e">numpy</span> <span style="color:#a6e22e">array</span> <span style="color:#a6e22e">is</span> <span style="color:#a6e22e">negative</span>, <span style="color:#a6e22e">and</span> <span style="color:#a6e22e">tensors</span> <span style="color:#66d9ef">with</span> <span style="color:#a6e22e">negative</span> <span style="color:#a6e22e">strides</span> <span style="color:#a6e22e">are</span> <span style="color:#a6e22e">not</span> <span style="color:#a6e22e">currently</span> <span style="color:#a6e22e">supported</span>. (<span style="color:#a6e22e">You</span> <span style="color:#a6e22e">can</span> <span style="color:#a6e22e">probably</span> <span style="color:#a6e22e">work</span> <span style="color:#a6e22e">around</span> <span style="color:#66d9ef">this</span> <span style="color:#a6e22e">by</span> <span style="color:#a6e22e">making</span> <span style="color:#a6e22e">a</span> <span style="color:#a6e22e">copy</span> <span style="color:#66d9ef">of</span> <span style="color:#a6e22e">your</span> <span style="color:#a6e22e">array</span>  <span style="color:#66d9ef">with</span> <span style="color:#a6e22e">array</span>.<span style="color:#a6e22e">copy</span>().)
</span></span></code></pre></div><p>这个错误发生在你试图将一个有负步长的NumPy数组转换为PyTorch张量时。步长是在内存中跳过的字节数，以便在所有轴都为单位时，跳转到下一个元素。</p>
<p>在NumPy中，当数组是另一个被-1步长切片的数组的视图时，该数组可能有负步长。目前，PyTorch不支持负步长，因此会出现这个错误。</p>
<p>要解决这个问题，你可以在将NumPy数组转换为PyTorch张量之前复制一份你的NumPy数组。当你在一个NumPy数组上调用 .copy() 方法时，它会创建一个具有正步长的新数组。</p>
<p>在date_loader.py文件 ToTensorLab类中 修改即可</p>
<h2 id="第二错">第二错</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">File</span> <span style="color:#e6db74">&#34;/home/user/anaconda3/envs/open-mmlab/lib/python3.7/site-packages/torch/utils/data/_utils/collate.py&#34;</span>, <span style="color:#a6e22e">line</span> <span style="color:#ae81ff">55</span>, <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">default_collate</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">torch</span>.<span style="color:#a6e22e">stack</span>(<span style="color:#a6e22e">batch</span>, <span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">out</span><span style="color:#f92672">=</span><span style="color:#a6e22e">out</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">RuntimeError</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">result</span> <span style="color:#a6e22e">type</span> <span style="color:#a6e22e">Double</span> <span style="color:#a6e22e">can</span><span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">t</span> <span style="color:#a6e22e">be</span> <span style="color:#a6e22e">cast</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">the</span> <span style="color:#a6e22e">desired</span> <span style="color:#a6e22e">output</span> <span style="color:#a6e22e">type</span> <span style="color:#a6e22e">Byte</span>
</span></span></code></pre></div><p>这个错误出现在 torch.utils.data._utils.collate.default_collate 函数中，该函数用于将一个数据批次（batch）的数据堆叠在一起。该错误表明，你试图将一批类型为 Double 的数据堆叠起来，然后尝试将结果转换为 Byte 类型，但这种转换不被允许。</p>
<p>可以尝试自定义 collate_fn 函数来处理类型转换。例如，你可以创建一个函数，该函数接受一批数据，将其转换为 Double 类型，然后再进行堆叠。这个函数可以替代 default_collate 函数。然后，你可以在创建 DataLoader 时，将这个函数作为 collate_fn 参数传入。</p>
<h2 id="修改后的文件代码如下">修改后的文件代码如下</h2>
<h3 id="data_loaderpy">data_loader.py</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">data</span> <span style="color:#a6e22e">loader</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">from</span> <span style="color:#a6e22e">__future__</span> <span style="color:#66d9ef">import</span> <span style="color:#a6e22e">print_function</span>, <span style="color:#a6e22e">division</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">glob</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">torch</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">from</span> <span style="color:#a6e22e">skimage</span> <span style="color:#66d9ef">import</span> <span style="color:#a6e22e">io</span>, <span style="color:#a6e22e">transform</span>, <span style="color:#a6e22e">color</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">numpy</span> <span style="color:#a6e22e">as</span> <span style="color:#a6e22e">np</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">random</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">math</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">matplotlib</span>.<span style="color:#a6e22e">pyplot</span> <span style="color:#a6e22e">as</span> <span style="color:#a6e22e">plt</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">from</span> <span style="color:#a6e22e">torch</span>.<span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">data</span> <span style="color:#66d9ef">import</span> <span style="color:#a6e22e">Dataset</span>, <span style="color:#a6e22e">DataLoader</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">from</span> <span style="color:#a6e22e">torchvision</span> <span style="color:#66d9ef">import</span> <span style="color:#a6e22e">transforms</span>, <span style="color:#a6e22e">utils</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">from</span> <span style="color:#a6e22e">PIL</span> <span style="color:#66d9ef">import</span> <span style="color:#a6e22e">Image</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span><span style="color:#f92672">==========================</span><span style="color:#a6e22e">dataset</span> <span style="color:#a6e22e">load</span><span style="color:#f92672">==========================</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RescaleT</span>(<span style="color:#a6e22e">object</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">def</span> <span style="color:#a6e22e">__init__</span>(<span style="color:#a6e22e">self</span>,<span style="color:#a6e22e">output_size</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">assert</span> <span style="color:#a6e22e">isinstance</span>(<span style="color:#a6e22e">output_size</span>,(<span style="color:#66d9ef">int</span>,<span style="color:#a6e22e">tuple</span>))
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">output_size</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">output_size</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">def</span> <span style="color:#a6e22e">__call__</span>(<span style="color:#a6e22e">self</span>,<span style="color:#a6e22e">sample</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">imidx</span>, <span style="color:#a6e22e">image</span>, <span style="color:#a6e22e">label</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">sample</span>[<span style="color:#e6db74">&#39;imidx&#39;</span>], <span style="color:#a6e22e">sample</span>[<span style="color:#e6db74">&#39;image&#39;</span>],<span style="color:#a6e22e">sample</span>[<span style="color:#e6db74">&#39;label&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">h</span>, <span style="color:#a6e22e">w</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">image</span>.<span style="color:#a6e22e">shape</span>[<span style="color:#f92672">:</span><span style="color:#ae81ff">2</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">isinstance</span>(<span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">output_size</span>,<span style="color:#66d9ef">int</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">h</span> <span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">w</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">new_h</span>, <span style="color:#a6e22e">new_w</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">output_size</span><span style="color:#f92672">*</span><span style="color:#a6e22e">h</span><span style="color:#f92672">/</span><span style="color:#a6e22e">w</span>,<span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">output_size</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">new_h</span>, <span style="color:#a6e22e">new_w</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">output_size</span>,<span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">output_size</span><span style="color:#f92672">*</span><span style="color:#a6e22e">w</span><span style="color:#f92672">/</span><span style="color:#a6e22e">h</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">new_h</span>, <span style="color:#a6e22e">new_w</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">output_size</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">new_h</span>, <span style="color:#a6e22e">new_w</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">int</span>(<span style="color:#a6e22e">new_h</span>), <span style="color:#66d9ef">int</span>(<span style="color:#a6e22e">new_w</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">resize</span> <span style="color:#a6e22e">the</span> <span style="color:#a6e22e">image</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">new_h</span> <span style="color:#a6e22e">x</span> <span style="color:#a6e22e">new_w</span> <span style="color:#a6e22e">and</span> <span style="color:#a6e22e">convert</span> <span style="color:#a6e22e">image</span> <span style="color:#a6e22e">from</span> <span style="color:#a6e22e">range</span> [<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">255</span>] <span style="color:#a6e22e">to</span> [<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>		<span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">img</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">transform</span>.<span style="color:#a6e22e">resize</span>(<span style="color:#a6e22e">image</span>,(<span style="color:#a6e22e">new_h</span>,<span style="color:#a6e22e">new_w</span>),<span style="color:#a6e22e">mode</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;constant&#39;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">lbl</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">transform</span>.<span style="color:#a6e22e">resize</span>(<span style="color:#a6e22e">label</span>,(<span style="color:#a6e22e">new_h</span>,<span style="color:#a6e22e">new_w</span>),<span style="color:#a6e22e">mode</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;constant&#39;</span>, <span style="color:#a6e22e">order</span><span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">preserve_range</span><span style="color:#f92672">=</span><span style="color:#a6e22e">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">img</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">transform</span>.<span style="color:#a6e22e">resize</span>(<span style="color:#a6e22e">image</span>,(<span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">output_size</span>,<span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">output_size</span>),<span style="color:#a6e22e">mode</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;constant&#39;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">lbl</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">transform</span>.<span style="color:#a6e22e">resize</span>(<span style="color:#a6e22e">label</span>,(<span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">output_size</span>,<span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">output_size</span>),<span style="color:#a6e22e">mode</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;constant&#39;</span>, <span style="color:#a6e22e">order</span><span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">preserve_range</span><span style="color:#f92672">=</span><span style="color:#a6e22e">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> {<span style="color:#e6db74">&#39;imidx&#39;</span><span style="color:#f92672">:</span><span style="color:#a6e22e">imidx</span>, <span style="color:#e6db74">&#39;image&#39;</span><span style="color:#f92672">:</span><span style="color:#a6e22e">img</span>,<span style="color:#e6db74">&#39;label&#39;</span><span style="color:#f92672">:</span><span style="color:#a6e22e">lbl</span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Rescale</span>(<span style="color:#a6e22e">object</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">def</span> <span style="color:#a6e22e">__init__</span>(<span style="color:#a6e22e">self</span>,<span style="color:#a6e22e">output_size</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">assert</span> <span style="color:#a6e22e">isinstance</span>(<span style="color:#a6e22e">output_size</span>,(<span style="color:#66d9ef">int</span>,<span style="color:#a6e22e">tuple</span>))
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">output_size</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">output_size</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">def</span> <span style="color:#a6e22e">__call__</span>(<span style="color:#a6e22e">self</span>,<span style="color:#a6e22e">sample</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">imidx</span>, <span style="color:#a6e22e">image</span>, <span style="color:#a6e22e">label</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">sample</span>[<span style="color:#e6db74">&#39;imidx&#39;</span>], <span style="color:#a6e22e">sample</span>[<span style="color:#e6db74">&#39;image&#39;</span>],<span style="color:#a6e22e">sample</span>[<span style="color:#e6db74">&#39;label&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">random</span>.<span style="color:#a6e22e">random</span>() <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0.5</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">image</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">image</span>[<span style="color:#f92672">::-</span><span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">label</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">label</span>[<span style="color:#f92672">::-</span><span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">h</span>, <span style="color:#a6e22e">w</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">image</span>.<span style="color:#a6e22e">shape</span>[<span style="color:#f92672">:</span><span style="color:#ae81ff">2</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">isinstance</span>(<span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">output_size</span>,<span style="color:#66d9ef">int</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">h</span> <span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">w</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">new_h</span>, <span style="color:#a6e22e">new_w</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">output_size</span><span style="color:#f92672">*</span><span style="color:#a6e22e">h</span><span style="color:#f92672">/</span><span style="color:#a6e22e">w</span>,<span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">output_size</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">new_h</span>, <span style="color:#a6e22e">new_w</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">output_size</span>,<span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">output_size</span><span style="color:#f92672">*</span><span style="color:#a6e22e">w</span><span style="color:#f92672">/</span><span style="color:#a6e22e">h</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">new_h</span>, <span style="color:#a6e22e">new_w</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">output_size</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">new_h</span>, <span style="color:#a6e22e">new_w</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">int</span>(<span style="color:#a6e22e">new_h</span>), <span style="color:#66d9ef">int</span>(<span style="color:#a6e22e">new_w</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">resize</span> <span style="color:#a6e22e">the</span> <span style="color:#a6e22e">image</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">new_h</span> <span style="color:#a6e22e">x</span> <span style="color:#a6e22e">new_w</span> <span style="color:#a6e22e">and</span> <span style="color:#a6e22e">convert</span> <span style="color:#a6e22e">image</span> <span style="color:#a6e22e">from</span> <span style="color:#a6e22e">range</span> [<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">255</span>] <span style="color:#a6e22e">to</span> [<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">img</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">transform</span>.<span style="color:#a6e22e">resize</span>(<span style="color:#a6e22e">image</span>,(<span style="color:#a6e22e">new_h</span>,<span style="color:#a6e22e">new_w</span>),<span style="color:#a6e22e">mode</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;constant&#39;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">lbl</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">transform</span>.<span style="color:#a6e22e">resize</span>(<span style="color:#a6e22e">label</span>,(<span style="color:#a6e22e">new_h</span>,<span style="color:#a6e22e">new_w</span>),<span style="color:#a6e22e">mode</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;constant&#39;</span>, <span style="color:#a6e22e">order</span><span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">preserve_range</span><span style="color:#f92672">=</span><span style="color:#a6e22e">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> {<span style="color:#e6db74">&#39;imidx&#39;</span><span style="color:#f92672">:</span><span style="color:#a6e22e">imidx</span>, <span style="color:#e6db74">&#39;image&#39;</span><span style="color:#f92672">:</span><span style="color:#a6e22e">img</span>,<span style="color:#e6db74">&#39;label&#39;</span><span style="color:#f92672">:</span><span style="color:#a6e22e">lbl</span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RandomCrop</span>(<span style="color:#a6e22e">object</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">def</span> <span style="color:#a6e22e">__init__</span>(<span style="color:#a6e22e">self</span>,<span style="color:#a6e22e">output_size</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">assert</span> <span style="color:#a6e22e">isinstance</span>(<span style="color:#a6e22e">output_size</span>, (<span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">tuple</span>))
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">isinstance</span>(<span style="color:#a6e22e">output_size</span>, <span style="color:#66d9ef">int</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">output_size</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">output_size</span>, <span style="color:#a6e22e">output_size</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">assert</span> <span style="color:#a6e22e">len</span>(<span style="color:#a6e22e">output_size</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">output_size</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">output_size</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">def</span> <span style="color:#a6e22e">__call__</span>(<span style="color:#a6e22e">self</span>,<span style="color:#a6e22e">sample</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">imidx</span>, <span style="color:#a6e22e">image</span>, <span style="color:#a6e22e">label</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">sample</span>[<span style="color:#e6db74">&#39;imidx&#39;</span>], <span style="color:#a6e22e">sample</span>[<span style="color:#e6db74">&#39;image&#39;</span>], <span style="color:#a6e22e">sample</span>[<span style="color:#e6db74">&#39;label&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">random</span>.<span style="color:#a6e22e">random</span>() <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0.5</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">image</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">image</span>[<span style="color:#f92672">::-</span><span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">label</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">label</span>[<span style="color:#f92672">::-</span><span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">h</span>, <span style="color:#a6e22e">w</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">image</span>.<span style="color:#a6e22e">shape</span>[<span style="color:#f92672">:</span><span style="color:#ae81ff">2</span>]
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">new_h</span>, <span style="color:#a6e22e">new_w</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">output_size</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">top</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">random</span>.<span style="color:#a6e22e">randint</span>(<span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">h</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">new_h</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">left</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">random</span>.<span style="color:#a6e22e">randint</span>(<span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">w</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">new_w</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">image</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">image</span>[<span style="color:#a6e22e">top</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">top</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">new_h</span>, <span style="color:#a6e22e">left</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">left</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">new_w</span>]
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">label</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">label</span>[<span style="color:#a6e22e">top</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">top</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">new_h</span>, <span style="color:#a6e22e">left</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">left</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">new_w</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> {<span style="color:#e6db74">&#39;imidx&#39;</span><span style="color:#f92672">:</span><span style="color:#a6e22e">imidx</span>,<span style="color:#e6db74">&#39;image&#39;</span><span style="color:#f92672">:</span><span style="color:#a6e22e">image</span>, <span style="color:#e6db74">&#39;label&#39;</span><span style="color:#f92672">:</span><span style="color:#a6e22e">label</span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ToTensor</span>(<span style="color:#a6e22e">object</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;&#34;&#34;Convert ndarrays in sample to Tensors.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">def</span> <span style="color:#a6e22e">__call__</span>(<span style="color:#a6e22e">self</span>, <span style="color:#a6e22e">sample</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">imidx</span>, <span style="color:#a6e22e">image</span>, <span style="color:#a6e22e">label</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">sample</span>[<span style="color:#e6db74">&#39;imidx&#39;</span>], <span style="color:#a6e22e">sample</span>[<span style="color:#e6db74">&#39;image&#39;</span>], <span style="color:#a6e22e">sample</span>[<span style="color:#e6db74">&#39;label&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">tmpImg</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">zeros</span>((<span style="color:#a6e22e">image</span>.<span style="color:#a6e22e">shape</span>[<span style="color:#ae81ff">0</span>],<span style="color:#a6e22e">image</span>.<span style="color:#a6e22e">shape</span>[<span style="color:#ae81ff">1</span>],<span style="color:#ae81ff">3</span>))
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">tmpLbl</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">zeros</span>(<span style="color:#a6e22e">label</span>.<span style="color:#a6e22e">shape</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">image</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">image</span><span style="color:#f92672">/</span><span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">max</span>(<span style="color:#a6e22e">image</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">max</span>(<span style="color:#a6e22e">label</span>)<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">1e-6</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">label</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">label</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">label</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">label</span><span style="color:#f92672">/</span><span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">max</span>(<span style="color:#a6e22e">label</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">image</span>.<span style="color:#a6e22e">shape</span>[<span style="color:#ae81ff">2</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> (<span style="color:#a6e22e">image</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">0</span>]<span style="color:#f92672">-</span><span style="color:#ae81ff">0.485</span>)<span style="color:#f92672">/</span><span style="color:#ae81ff">0.229</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> (<span style="color:#a6e22e">image</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">0</span>]<span style="color:#f92672">-</span><span style="color:#ae81ff">0.485</span>)<span style="color:#f92672">/</span><span style="color:#ae81ff">0.229</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> (<span style="color:#a6e22e">image</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">0</span>]<span style="color:#f92672">-</span><span style="color:#ae81ff">0.485</span>)<span style="color:#f92672">/</span><span style="color:#ae81ff">0.229</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> (<span style="color:#a6e22e">image</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">0</span>]<span style="color:#f92672">-</span><span style="color:#ae81ff">0.485</span>)<span style="color:#f92672">/</span><span style="color:#ae81ff">0.229</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> (<span style="color:#a6e22e">image</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">1</span>]<span style="color:#f92672">-</span><span style="color:#ae81ff">0.456</span>)<span style="color:#f92672">/</span><span style="color:#ae81ff">0.224</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> (<span style="color:#a6e22e">image</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">2</span>]<span style="color:#f92672">-</span><span style="color:#ae81ff">0.406</span>)<span style="color:#f92672">/</span><span style="color:#ae81ff">0.225</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">tmpLbl</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">label</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">tmpImg</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">tmpImg</span>.<span style="color:#a6e22e">transpose</span>((<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">tmpLbl</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">label</span>.<span style="color:#a6e22e">transpose</span>((<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> {<span style="color:#e6db74">&#39;imidx&#39;</span><span style="color:#f92672">:</span><span style="color:#a6e22e">torch</span>.<span style="color:#a6e22e">from_numpy</span>(<span style="color:#a6e22e">imidx</span>), <span style="color:#e6db74">&#39;image&#39;</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">torch</span>.<span style="color:#a6e22e">from_numpy</span>(<span style="color:#a6e22e">tmpImg</span>), <span style="color:#e6db74">&#39;label&#39;</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">torch</span>.<span style="color:#a6e22e">from_numpy</span>(<span style="color:#a6e22e">tmpLbl</span>)}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ToTensorLab</span>(<span style="color:#a6e22e">object</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;&#34;&#34;Convert ndarrays in sample to Tensors.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">def</span> <span style="color:#a6e22e">__init__</span>(<span style="color:#a6e22e">self</span>,<span style="color:#a6e22e">flag</span><span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">flag</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">flag</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">label_fal</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">def</span> <span style="color:#a6e22e">__call__</span>(<span style="color:#a6e22e">self</span>, <span style="color:#a6e22e">sample</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">imidx</span>, <span style="color:#a6e22e">image</span>, <span style="color:#a6e22e">label</span> <span style="color:#f92672">=</span><span style="color:#a6e22e">sample</span>[<span style="color:#e6db74">&#39;imidx&#39;</span>], <span style="color:#a6e22e">sample</span>[<span style="color:#e6db74">&#39;image&#39;</span>], <span style="color:#a6e22e">sample</span>[<span style="color:#e6db74">&#39;label&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">tmpLbl</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">zeros</span>(<span style="color:#a6e22e">label</span>.<span style="color:#a6e22e">shape</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">max</span>(<span style="color:#a6e22e">label</span>)<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">1e-6</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">label</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">label</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">label_fal</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">label</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">label</span><span style="color:#f92672">/</span><span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">max</span>(<span style="color:#a6e22e">label</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">change</span> <span style="color:#a6e22e">the</span> <span style="color:#a6e22e">color</span> <span style="color:#a6e22e">space</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">flag</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">:</span> <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#66d9ef">with</span> <span style="color:#a6e22e">rgb</span> <span style="color:#a6e22e">and</span> <span style="color:#a6e22e">Lab</span> <span style="color:#a6e22e">colors</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">tmpImg</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">zeros</span>((<span style="color:#a6e22e">image</span>.<span style="color:#a6e22e">shape</span>[<span style="color:#ae81ff">0</span>],<span style="color:#a6e22e">image</span>.<span style="color:#a6e22e">shape</span>[<span style="color:#ae81ff">1</span>],<span style="color:#ae81ff">6</span>))
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">tmpImgt</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">zeros</span>((<span style="color:#a6e22e">image</span>.<span style="color:#a6e22e">shape</span>[<span style="color:#ae81ff">0</span>],<span style="color:#a6e22e">image</span>.<span style="color:#a6e22e">shape</span>[<span style="color:#ae81ff">1</span>],<span style="color:#ae81ff">3</span>))
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">image</span>.<span style="color:#a6e22e">shape</span>[<span style="color:#ae81ff">2</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">tmpImgt</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">image</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">tmpImgt</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">image</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">tmpImgt</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">image</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">tmpImgt</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">image</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">tmpImgtl</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">color</span>.<span style="color:#a6e22e">rgb2lab</span>(<span style="color:#a6e22e">tmpImgt</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">nomalize</span> <span style="color:#a6e22e">image</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">range</span> [<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> (<span style="color:#a6e22e">tmpImgt</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">0</span>]<span style="color:#f92672">-</span><span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">min</span>(<span style="color:#a6e22e">tmpImgt</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">0</span>]))<span style="color:#f92672">/</span>(<span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">max</span>(<span style="color:#a6e22e">tmpImgt</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">0</span>])<span style="color:#f92672">-</span><span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">min</span>(<span style="color:#a6e22e">tmpImgt</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">0</span>]))
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> (<span style="color:#a6e22e">tmpImgt</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">1</span>]<span style="color:#f92672">-</span><span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">min</span>(<span style="color:#a6e22e">tmpImgt</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">1</span>]))<span style="color:#f92672">/</span>(<span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">max</span>(<span style="color:#a6e22e">tmpImgt</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">1</span>])<span style="color:#f92672">-</span><span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">min</span>(<span style="color:#a6e22e">tmpImgt</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">1</span>]))
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> (<span style="color:#a6e22e">tmpImgt</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">2</span>]<span style="color:#f92672">-</span><span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">min</span>(<span style="color:#a6e22e">tmpImgt</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">2</span>]))<span style="color:#f92672">/</span>(<span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">max</span>(<span style="color:#a6e22e">tmpImgt</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">2</span>])<span style="color:#f92672">-</span><span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">min</span>(<span style="color:#a6e22e">tmpImgt</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">2</span>]))
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">3</span>] <span style="color:#f92672">=</span> (<span style="color:#a6e22e">tmpImgtl</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">0</span>]<span style="color:#f92672">-</span><span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">min</span>(<span style="color:#a6e22e">tmpImgtl</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">0</span>]))<span style="color:#f92672">/</span>(<span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">max</span>(<span style="color:#a6e22e">tmpImgtl</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">0</span>])<span style="color:#f92672">-</span><span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">min</span>(<span style="color:#a6e22e">tmpImgtl</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">0</span>]))
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">4</span>] <span style="color:#f92672">=</span> (<span style="color:#a6e22e">tmpImgtl</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">1</span>]<span style="color:#f92672">-</span><span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">min</span>(<span style="color:#a6e22e">tmpImgtl</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">1</span>]))<span style="color:#f92672">/</span>(<span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">max</span>(<span style="color:#a6e22e">tmpImgtl</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">1</span>])<span style="color:#f92672">-</span><span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">min</span>(<span style="color:#a6e22e">tmpImgtl</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">1</span>]))
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">5</span>] <span style="color:#f92672">=</span> (<span style="color:#a6e22e">tmpImgtl</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">2</span>]<span style="color:#f92672">-</span><span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">min</span>(<span style="color:#a6e22e">tmpImgtl</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">2</span>]))<span style="color:#f92672">/</span>(<span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">max</span>(<span style="color:#a6e22e">tmpImgtl</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">2</span>])<span style="color:#f92672">-</span><span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">min</span>(<span style="color:#a6e22e">tmpImgtl</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">2</span>]))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">tmpImg</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">tmpImg</span><span style="color:#f92672">/</span>(<span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">max</span>(<span style="color:#a6e22e">tmpImg</span>)<span style="color:#f92672">-</span><span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">min</span>(<span style="color:#a6e22e">tmpImg</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> (<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">0</span>]<span style="color:#f92672">-</span><span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">mean</span>(<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">0</span>]))<span style="color:#f92672">/</span><span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">std</span>(<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">0</span>])
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> (<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">1</span>]<span style="color:#f92672">-</span><span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">mean</span>(<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">1</span>]))<span style="color:#f92672">/</span><span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">std</span>(<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> (<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">2</span>]<span style="color:#f92672">-</span><span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">mean</span>(<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">2</span>]))<span style="color:#f92672">/</span><span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">std</span>(<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">2</span>])
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">3</span>] <span style="color:#f92672">=</span> (<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">3</span>]<span style="color:#f92672">-</span><span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">mean</span>(<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">3</span>]))<span style="color:#f92672">/</span><span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">std</span>(<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">3</span>])
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">4</span>] <span style="color:#f92672">=</span> (<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">4</span>]<span style="color:#f92672">-</span><span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">mean</span>(<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">4</span>]))<span style="color:#f92672">/</span><span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">std</span>(<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">4</span>])
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">5</span>] <span style="color:#f92672">=</span> (<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">5</span>]<span style="color:#f92672">-</span><span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">mean</span>(<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">5</span>]))<span style="color:#f92672">/</span><span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">std</span>(<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">5</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">elif</span> <span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">flag</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">:</span> <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#66d9ef">with</span> <span style="color:#a6e22e">Lab</span> <span style="color:#a6e22e">color</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">tmpImg</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">zeros</span>((<span style="color:#a6e22e">image</span>.<span style="color:#a6e22e">shape</span>[<span style="color:#ae81ff">0</span>],<span style="color:#a6e22e">image</span>.<span style="color:#a6e22e">shape</span>[<span style="color:#ae81ff">1</span>],<span style="color:#ae81ff">3</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">image</span>.<span style="color:#a6e22e">shape</span>[<span style="color:#ae81ff">2</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">image</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">image</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">image</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">tmpImg</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">image</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">tmpImg</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">color</span>.<span style="color:#a6e22e">rgb2lab</span>(<span style="color:#a6e22e">tmpImg</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">tmpImg</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">tmpImg</span><span style="color:#f92672">/</span>(<span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">max</span>(<span style="color:#a6e22e">tmpImg</span>)<span style="color:#f92672">-</span><span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">min</span>(<span style="color:#a6e22e">tmpImg</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> (<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">0</span>]<span style="color:#f92672">-</span><span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">min</span>(<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">0</span>]))<span style="color:#f92672">/</span>(<span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">max</span>(<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">0</span>])<span style="color:#f92672">-</span><span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">min</span>(<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">0</span>]))
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> (<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">1</span>]<span style="color:#f92672">-</span><span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">min</span>(<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">1</span>]))<span style="color:#f92672">/</span>(<span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">max</span>(<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">1</span>])<span style="color:#f92672">-</span><span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">min</span>(<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">1</span>]))
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> (<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">2</span>]<span style="color:#f92672">-</span><span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">min</span>(<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">2</span>]))<span style="color:#f92672">/</span>(<span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">max</span>(<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">2</span>])<span style="color:#f92672">-</span><span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">min</span>(<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">2</span>]))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> (<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">0</span>]<span style="color:#f92672">-</span><span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">mean</span>(<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">0</span>]))<span style="color:#f92672">/</span><span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">std</span>(<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">0</span>])
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> (<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">1</span>]<span style="color:#f92672">-</span><span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">mean</span>(<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">1</span>]))<span style="color:#f92672">/</span><span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">std</span>(<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> (<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">2</span>]<span style="color:#f92672">-</span><span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">mean</span>(<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">2</span>]))<span style="color:#f92672">/</span><span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">std</span>(<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">2</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">else</span><span style="color:#f92672">:</span> <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#66d9ef">with</span> <span style="color:#a6e22e">rgb</span> <span style="color:#a6e22e">color</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">tmpImg</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">zeros</span>((<span style="color:#a6e22e">image</span>.<span style="color:#a6e22e">shape</span>[<span style="color:#ae81ff">0</span>],<span style="color:#a6e22e">image</span>.<span style="color:#a6e22e">shape</span>[<span style="color:#ae81ff">1</span>],<span style="color:#ae81ff">3</span>))
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">image</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">image</span><span style="color:#f92672">/</span><span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">max</span>(<span style="color:#a6e22e">image</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">image</span>.<span style="color:#a6e22e">shape</span>[<span style="color:#ae81ff">2</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> (<span style="color:#a6e22e">image</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">0</span>]<span style="color:#f92672">-</span><span style="color:#ae81ff">0.485</span>)<span style="color:#f92672">/</span><span style="color:#ae81ff">0.229</span>
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> (<span style="color:#a6e22e">image</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">0</span>]<span style="color:#f92672">-</span><span style="color:#ae81ff">0.485</span>)<span style="color:#f92672">/</span><span style="color:#ae81ff">0.229</span>
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> (<span style="color:#a6e22e">image</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">0</span>]<span style="color:#f92672">-</span><span style="color:#ae81ff">0.485</span>)<span style="color:#f92672">/</span><span style="color:#ae81ff">0.229</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> (<span style="color:#a6e22e">image</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">0</span>]<span style="color:#f92672">-</span><span style="color:#ae81ff">0.485</span>)<span style="color:#f92672">/</span><span style="color:#ae81ff">0.229</span>
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> (<span style="color:#a6e22e">image</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">1</span>]<span style="color:#f92672">-</span><span style="color:#ae81ff">0.456</span>)<span style="color:#f92672">/</span><span style="color:#ae81ff">0.224</span>
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> (<span style="color:#a6e22e">image</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">2</span>]<span style="color:#f92672">-</span><span style="color:#ae81ff">0.406</span>)<span style="color:#f92672">/</span><span style="color:#ae81ff">0.225</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">tmpLbl</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">label</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">tmpImg</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">tmpImg</span>.<span style="color:#a6e22e">transpose</span>((<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">tmpLbl</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">label</span>.<span style="color:#a6e22e">transpose</span>((<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">label_fal</span> <span style="color:#f92672">==</span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">tmpLbl</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">tmpLbl</span>.<span style="color:#a6e22e">copy</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> {<span style="color:#e6db74">&#39;imidx&#39;</span><span style="color:#f92672">:</span><span style="color:#a6e22e">torch</span>.<span style="color:#a6e22e">from_numpy</span>(<span style="color:#a6e22e">imidx</span>), <span style="color:#e6db74">&#39;image&#39;</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">torch</span>.<span style="color:#a6e22e">from_numpy</span>(<span style="color:#a6e22e">tmpImg</span>), <span style="color:#e6db74">&#39;label&#39;</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">torch</span>.<span style="color:#a6e22e">from_numpy</span>(<span style="color:#a6e22e">tmpLbl</span>)}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SalObjDataset</span>(<span style="color:#a6e22e">Dataset</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">def</span> <span style="color:#a6e22e">__init__</span>(<span style="color:#a6e22e">self</span>,<span style="color:#a6e22e">img_name_list</span>,<span style="color:#a6e22e">lbl_name_list</span>,<span style="color:#a6e22e">transform</span><span style="color:#f92672">=</span><span style="color:#a6e22e">None</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">root_dir</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">root_dir</span>
</span></span><span style="display:flex;"><span>		<span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">image_name_list</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">glob</span>.<span style="color:#a6e22e">glob</span>(<span style="color:#a6e22e">image_dir</span><span style="color:#f92672">+</span><span style="color:#e6db74">&#39;*.png&#39;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">label_name_list</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">glob</span>.<span style="color:#a6e22e">glob</span>(<span style="color:#a6e22e">label_dir</span><span style="color:#f92672">+</span><span style="color:#e6db74">&#39;*.png&#39;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">image_name_list</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">img_name_list</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">label_name_list</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">lbl_name_list</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">transform</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">transform</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">def</span> <span style="color:#a6e22e">__len__</span>(<span style="color:#a6e22e">self</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">len</span>(<span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">image_name_list</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">def</span> <span style="color:#a6e22e">__getitem__</span>(<span style="color:#a6e22e">self</span>,<span style="color:#a6e22e">idx</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">image</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">Image</span>.<span style="color:#a6e22e">open</span>(<span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">image_name_list</span>[<span style="color:#a6e22e">idx</span>])<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">imread</span>(<span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">image_name_list</span>[<span style="color:#a6e22e">idx</span>])
</span></span><span style="display:flex;"><span>		<span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">label</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">Image</span>.<span style="color:#a6e22e">open</span>(<span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">label_name_list</span>[<span style="color:#a6e22e">idx</span>])<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">imread</span>(<span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">label_name_list</span>[<span style="color:#a6e22e">idx</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">image</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">imread</span>(<span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">image_name_list</span>[<span style="color:#a6e22e">idx</span>])
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">imname</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">image_name_list</span>[<span style="color:#a6e22e">idx</span>]
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">imidx</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">array</span>([<span style="color:#a6e22e">idx</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span>(<span style="color:#ae81ff">0</span><span style="color:#f92672">==</span><span style="color:#a6e22e">len</span>(<span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">label_name_list</span>))<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">label_3</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">zeros</span>(<span style="color:#a6e22e">image</span>.<span style="color:#a6e22e">shape</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">label_3</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">imread</span>(<span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">label_name_list</span>[<span style="color:#a6e22e">idx</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">label</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">zeros</span>(<span style="color:#a6e22e">label_3</span>.<span style="color:#a6e22e">shape</span>[<span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">2</span>])
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span>(<span style="color:#ae81ff">3</span><span style="color:#f92672">==</span><span style="color:#a6e22e">len</span>(<span style="color:#a6e22e">label_3</span>.<span style="color:#a6e22e">shape</span>))<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">label</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">label_3</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">elif</span>(<span style="color:#ae81ff">2</span><span style="color:#f92672">==</span><span style="color:#a6e22e">len</span>(<span style="color:#a6e22e">label_3</span>.<span style="color:#a6e22e">shape</span>))<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">label</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">label_3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span>(<span style="color:#ae81ff">3</span><span style="color:#f92672">==</span><span style="color:#a6e22e">len</span>(<span style="color:#a6e22e">image</span>.<span style="color:#a6e22e">shape</span>) <span style="color:#a6e22e">and</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">==</span><span style="color:#a6e22e">len</span>(<span style="color:#a6e22e">label</span>.<span style="color:#a6e22e">shape</span>))<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">label</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">label</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">newaxis</span>]
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">elif</span>(<span style="color:#ae81ff">2</span><span style="color:#f92672">==</span><span style="color:#a6e22e">len</span>(<span style="color:#a6e22e">image</span>.<span style="color:#a6e22e">shape</span>) <span style="color:#a6e22e">and</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">==</span><span style="color:#a6e22e">len</span>(<span style="color:#a6e22e">label</span>.<span style="color:#a6e22e">shape</span>))<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">image</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">image</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">newaxis</span>]
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">label</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">label</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">newaxis</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">sample</span> <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#39;imidx&#39;</span><span style="color:#f92672">:</span><span style="color:#a6e22e">imidx</span>, <span style="color:#e6db74">&#39;image&#39;</span><span style="color:#f92672">:</span><span style="color:#a6e22e">image</span>, <span style="color:#e6db74">&#39;label&#39;</span><span style="color:#f92672">:</span><span style="color:#a6e22e">label</span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">transform</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">sample</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">transform</span>(<span style="color:#a6e22e">sample</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">sample</span>
</span></span></code></pre></div><h3 id="train_ownpy">train_own.py</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">os</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">torch</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">torchvision</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">from</span> <span style="color:#a6e22e">torch</span>.<span style="color:#a6e22e">autograd</span> <span style="color:#66d9ef">import</span> <span style="color:#a6e22e">Variable</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">torch</span>.<span style="color:#a6e22e">nn</span> <span style="color:#a6e22e">as</span> <span style="color:#a6e22e">nn</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">torch</span>.<span style="color:#a6e22e">nn</span>.<span style="color:#a6e22e">functional</span> <span style="color:#a6e22e">as</span> <span style="color:#a6e22e">F</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">from</span> <span style="color:#a6e22e">torch</span>.<span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">data</span> <span style="color:#66d9ef">import</span> <span style="color:#a6e22e">Dataset</span>, <span style="color:#a6e22e">DataLoader</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">from</span> <span style="color:#a6e22e">torchvision</span> <span style="color:#66d9ef">import</span> <span style="color:#a6e22e">transforms</span>, <span style="color:#a6e22e">utils</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">torch</span>.<span style="color:#a6e22e">optim</span> <span style="color:#a6e22e">as</span> <span style="color:#a6e22e">optim</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">torchvision</span>.<span style="color:#a6e22e">transforms</span> <span style="color:#a6e22e">as</span> <span style="color:#a6e22e">standard_transforms</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">numpy</span> <span style="color:#a6e22e">as</span> <span style="color:#a6e22e">np</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">glob</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">os</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">from</span> <span style="color:#a6e22e">data_loader</span> <span style="color:#66d9ef">import</span> <span style="color:#a6e22e">Rescale</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">from</span> <span style="color:#a6e22e">data_loader</span> <span style="color:#66d9ef">import</span> <span style="color:#a6e22e">RescaleT</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">from</span> <span style="color:#a6e22e">data_loader</span> <span style="color:#66d9ef">import</span> <span style="color:#a6e22e">RandomCrop</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">from</span> <span style="color:#a6e22e">data_loader</span> <span style="color:#66d9ef">import</span> <span style="color:#a6e22e">ToTensor</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">from</span> <span style="color:#a6e22e">data_loader</span> <span style="color:#66d9ef">import</span> <span style="color:#a6e22e">ToTensorLab</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">from</span> <span style="color:#a6e22e">data_loader</span> <span style="color:#66d9ef">import</span> <span style="color:#a6e22e">SalObjDataset</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">from</span> <span style="color:#a6e22e">model</span> <span style="color:#66d9ef">import</span> <span style="color:#a6e22e">U2NET</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">from</span> <span style="color:#a6e22e">model</span> <span style="color:#66d9ef">import</span> <span style="color:#a6e22e">U2NETP</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#f92672">-------</span> <span style="color:#ae81ff">1.</span> <span style="color:#a6e22e">define</span> <span style="color:#a6e22e">loss</span> <span style="color:#66d9ef">function</span> <span style="color:#f92672">--------</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">bce_loss</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">nn</span>.<span style="color:#a6e22e">BCELoss</span>(<span style="color:#a6e22e">size_average</span><span style="color:#f92672">=</span><span style="color:#a6e22e">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">def</span> <span style="color:#a6e22e">muti_bce_loss_fusion</span>(<span style="color:#a6e22e">d0</span>, <span style="color:#a6e22e">d1</span>, <span style="color:#a6e22e">d2</span>, <span style="color:#a6e22e">d3</span>, <span style="color:#a6e22e">d4</span>, <span style="color:#a6e22e">d5</span>, <span style="color:#a6e22e">d6</span>, <span style="color:#a6e22e">labels_v</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">loss0</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">bce_loss</span>(<span style="color:#a6e22e">d0</span>,<span style="color:#a6e22e">labels_v</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">loss1</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">bce_loss</span>(<span style="color:#a6e22e">d1</span>,<span style="color:#a6e22e">labels_v</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">loss2</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">bce_loss</span>(<span style="color:#a6e22e">d2</span>,<span style="color:#a6e22e">labels_v</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">loss3</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">bce_loss</span>(<span style="color:#a6e22e">d3</span>,<span style="color:#a6e22e">labels_v</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">loss4</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">bce_loss</span>(<span style="color:#a6e22e">d4</span>,<span style="color:#a6e22e">labels_v</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">loss5</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">bce_loss</span>(<span style="color:#a6e22e">d5</span>,<span style="color:#a6e22e">labels_v</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">loss6</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">bce_loss</span>(<span style="color:#a6e22e">d6</span>,<span style="color:#a6e22e">labels_v</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">loss</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">loss0</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">loss1</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">loss2</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">loss3</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">loss4</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">loss5</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">loss6</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">print</span>(<span style="color:#e6db74">&#34;l0: %3f, l1: %3f, l2: %3f, l3: %3f, l4: %3f, l5: %3f, l6: %3f\n&#34;</span><span style="color:#f92672">%</span>(<span style="color:#a6e22e">loss0</span>.<span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">item</span>(),<span style="color:#a6e22e">loss1</span>.<span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">item</span>(),<span style="color:#a6e22e">loss2</span>.<span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">item</span>(),<span style="color:#a6e22e">loss3</span>.<span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">item</span>(),<span style="color:#a6e22e">loss4</span>.<span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">item</span>(),<span style="color:#a6e22e">loss5</span>.<span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">item</span>(),<span style="color:#a6e22e">loss6</span>.<span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">item</span>()))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">loss0</span>, <span style="color:#a6e22e">loss</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#f92672">-------</span> <span style="color:#ae81ff">2.</span> <span style="color:#a6e22e">set</span> <span style="color:#a6e22e">the</span> <span style="color:#a6e22e">directory</span> <span style="color:#66d9ef">of</span> <span style="color:#a6e22e">training</span> <span style="color:#a6e22e">dataset</span> <span style="color:#f92672">--------</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">model_name</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;u2net&#39;</span> <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#e6db74">&#39;u2netp&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">data_dir</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">path</span>.<span style="color:#a6e22e">join</span>(<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">getcwd</span>(), <span style="color:#e6db74">&#39;train_data&#39;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">sep</span>)
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">tra_image_dir</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">path</span>.<span style="color:#a6e22e">join</span>(<span style="color:#e6db74">&#39;DUTS&#39;</span>, <span style="color:#e6db74">&#39;DUTS-TR&#39;</span>, <span style="color:#e6db74">&#39;DUTS-TR&#39;</span>, <span style="color:#e6db74">&#39;im_aug&#39;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">sep</span>)
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">tra_label_dir</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">path</span>.<span style="color:#a6e22e">join</span>(<span style="color:#e6db74">&#39;DUTS&#39;</span>, <span style="color:#e6db74">&#39;DUTS-TR&#39;</span>, <span style="color:#e6db74">&#39;DUTS-TR&#39;</span>, <span style="color:#e6db74">&#39;gt_aug&#39;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">sep</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">data_dir</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">path</span>.<span style="color:#a6e22e">join</span>(<span style="color:#e6db74">&#39;/opt/data_al/20230801_u2net_waterZone/&#39;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">sep</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">tra_image_dir</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">path</span>.<span style="color:#a6e22e">join</span>(<span style="color:#e6db74">&#39;images&#39;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">sep</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">tra_label_dir</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">path</span>.<span style="color:#a6e22e">join</span>(<span style="color:#e6db74">&#39;labels&#39;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">sep</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">image_ext</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;.jpg&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">label_ext</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;.png&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">model_dir</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">path</span>.<span style="color:#a6e22e">join</span>(<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">getcwd</span>(), <span style="color:#e6db74">&#39;saved_models&#39;</span>, <span style="color:#a6e22e">model_name</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">sep</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">epoch_num</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">10000</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">batch_size_train</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">batch_size_val</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">train_num</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">val_num</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">tra_img_name_list</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">glob</span>.<span style="color:#a6e22e">glob</span>(<span style="color:#a6e22e">data_dir</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">tra_image_dir</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;*&#39;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">image_ext</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">tra_lbl_name_list</span> <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> <span style="color:#a6e22e">img_path</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">tra_img_name_list</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">img_name</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">img_path</span>.<span style="color:#a6e22e">split</span>(<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">sep</span>)[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">aaa</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">img_name</span>.<span style="color:#a6e22e">split</span>(<span style="color:#e6db74">&#34;.&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">bbb</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">aaa</span>[<span style="color:#ae81ff">0</span><span style="color:#f92672">:-</span><span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">imidx</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">bbb</span>[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">range</span>(<span style="color:#ae81ff">1</span>,<span style="color:#a6e22e">len</span>(<span style="color:#a6e22e">bbb</span>))<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">imidx</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">imidx</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;.&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">bbb</span>[<span style="color:#a6e22e">i</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">tra_lbl_name_list</span>.<span style="color:#a6e22e">append</span>(<span style="color:#a6e22e">data_dir</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">tra_label_dir</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">imidx</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">label_ext</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">print</span>(<span style="color:#e6db74">&#34;---&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">print</span>(<span style="color:#e6db74">&#34;train images: &#34;</span>, <span style="color:#a6e22e">len</span>(<span style="color:#a6e22e">tra_img_name_list</span>))
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">print</span>(<span style="color:#e6db74">&#34;train labels: &#34;</span>, <span style="color:#a6e22e">len</span>(<span style="color:#a6e22e">tra_lbl_name_list</span>))
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">print</span>(<span style="color:#e6db74">&#34;---&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">def</span> <span style="color:#a6e22e">my_collate_fn</span>(<span style="color:#a6e22e">batch</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">images</span> <span style="color:#f92672">=</span> [<span style="color:#a6e22e">item</span>[<span style="color:#e6db74">&#39;image&#39;</span>].<span style="color:#a6e22e">to</span>(<span style="color:#a6e22e">torch</span>.<span style="color:#66d9ef">double</span>) <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">item</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">batch</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">labels</span> <span style="color:#f92672">=</span> [<span style="color:#a6e22e">item</span>[<span style="color:#e6db74">&#39;label&#39;</span>].<span style="color:#a6e22e">to</span>(<span style="color:#a6e22e">torch</span>.<span style="color:#66d9ef">double</span>) <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">item</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">batch</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">imidxs</span> <span style="color:#f92672">=</span> [<span style="color:#a6e22e">item</span>[<span style="color:#e6db74">&#39;imidx&#39;</span>].<span style="color:#a6e22e">to</span>(<span style="color:#a6e22e">torch</span>.<span style="color:#66d9ef">double</span>)<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">item</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">batch</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> {<span style="color:#e6db74">&#39;imidx&#39;</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">torch</span>.<span style="color:#a6e22e">stack</span>(<span style="color:#a6e22e">imidxs</span>, <span style="color:#ae81ff">0</span>), <span style="color:#e6db74">&#39;image&#39;</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">torch</span>.<span style="color:#a6e22e">stack</span>(<span style="color:#a6e22e">images</span>, <span style="color:#ae81ff">0</span>), <span style="color:#e6db74">&#39;label&#39;</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">torch</span>.<span style="color:#a6e22e">stack</span>(<span style="color:#a6e22e">labels</span>, <span style="color:#ae81ff">0</span>)}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">train_num</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">len</span>(<span style="color:#a6e22e">tra_img_name_list</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">salobj_dataset</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">SalObjDataset</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">img_name_list</span><span style="color:#f92672">=</span><span style="color:#a6e22e">tra_img_name_list</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">lbl_name_list</span><span style="color:#f92672">=</span><span style="color:#a6e22e">tra_lbl_name_list</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">transform</span><span style="color:#f92672">=</span><span style="color:#a6e22e">transforms</span>.<span style="color:#a6e22e">Compose</span>([
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">RescaleT</span>(<span style="color:#ae81ff">320</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">RandomCrop</span>(<span style="color:#ae81ff">288</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">ToTensorLab</span>(<span style="color:#a6e22e">flag</span><span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)]))
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">salobj_dataloader</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">DataLoader</span>(<span style="color:#a6e22e">salobj_dataset</span>, <span style="color:#a6e22e">batch_size</span><span style="color:#f92672">=</span><span style="color:#a6e22e">batch_size_train</span>, <span style="color:#a6e22e">shuffle</span><span style="color:#f92672">=</span><span style="color:#a6e22e">True</span>, <span style="color:#a6e22e">num_workers</span><span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,<span style="color:#a6e22e">collate_fn</span><span style="color:#f92672">=</span><span style="color:#a6e22e">my_collate_fn</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#f92672">-------</span> <span style="color:#ae81ff">3.</span> <span style="color:#a6e22e">define</span> <span style="color:#a6e22e">model</span> <span style="color:#f92672">--------</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">define</span> <span style="color:#a6e22e">the</span> <span style="color:#a6e22e">net</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">model_name</span><span style="color:#f92672">==</span><span style="color:#e6db74">&#39;u2net&#39;</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">net</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">U2NET</span>(<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">elif</span>(<span style="color:#a6e22e">model_name</span><span style="color:#f92672">==</span><span style="color:#e6db74">&#39;u2netp&#39;</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">net</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">U2NETP</span>(<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">torch</span>.<span style="color:#a6e22e">cuda</span>.<span style="color:#a6e22e">is_available</span>()<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">cuda</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#f92672">-------</span> <span style="color:#ae81ff">4.</span> <span style="color:#a6e22e">define</span> <span style="color:#a6e22e">optimizer</span> <span style="color:#f92672">--------</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">print</span>(<span style="color:#e6db74">&#34;---define optimizer...&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">optimizer</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">optim</span>.<span style="color:#a6e22e">Adam</span>(<span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">parameters</span>(), <span style="color:#a6e22e">lr</span><span style="color:#f92672">=</span><span style="color:#ae81ff">0.001</span>, <span style="color:#a6e22e">betas</span><span style="color:#f92672">=</span>(<span style="color:#ae81ff">0.9</span>, <span style="color:#ae81ff">0.999</span>), <span style="color:#a6e22e">eps</span><span style="color:#f92672">=</span><span style="color:#ae81ff">1e-08</span>, <span style="color:#a6e22e">weight_decay</span><span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#f92672">-------</span> <span style="color:#ae81ff">5.</span> <span style="color:#a6e22e">training</span> <span style="color:#a6e22e">process</span> <span style="color:#f92672">--------</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">print</span>(<span style="color:#e6db74">&#34;---start training...&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ite_num</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">running_loss</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">running_tar_loss</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ite_num4val</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">save_frq</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">2000</span> <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">save</span> <span style="color:#a6e22e">the</span> <span style="color:#a6e22e">model</span> <span style="color:#a6e22e">every</span> <span style="color:#ae81ff">2000</span> <span style="color:#a6e22e">iterations</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> <span style="color:#a6e22e">epoch</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">range</span>(<span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">epoch_num</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">train</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">data</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">enumerate</span>(<span style="color:#a6e22e">salobj_dataloader</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">ite_num</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ite_num</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">ite_num4val</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ite_num4val</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">inputs</span>, <span style="color:#a6e22e">labels</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">data</span>[<span style="color:#e6db74">&#39;image&#39;</span>], <span style="color:#a6e22e">data</span>[<span style="color:#e6db74">&#39;label&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">inputs</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">inputs</span>.<span style="color:#a6e22e">type</span>(<span style="color:#a6e22e">torch</span>.<span style="color:#a6e22e">FloatTensor</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">labels</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">labels</span>.<span style="color:#a6e22e">type</span>(<span style="color:#a6e22e">torch</span>.<span style="color:#a6e22e">FloatTensor</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">wrap</span> <span style="color:#a6e22e">them</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">Variable</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">torch</span>.<span style="color:#a6e22e">cuda</span>.<span style="color:#a6e22e">is_available</span>()<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">inputs_v</span>, <span style="color:#a6e22e">labels_v</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">Variable</span>(<span style="color:#a6e22e">inputs</span>.<span style="color:#a6e22e">cuda</span>(), <span style="color:#a6e22e">requires_grad</span><span style="color:#f92672">=</span><span style="color:#a6e22e">False</span>), <span style="color:#a6e22e">Variable</span>(<span style="color:#a6e22e">labels</span>.<span style="color:#a6e22e">cuda</span>(),
</span></span><span style="display:flex;"><span>                                                                                        <span style="color:#a6e22e">requires_grad</span><span style="color:#f92672">=</span><span style="color:#a6e22e">False</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">inputs_v</span>, <span style="color:#a6e22e">labels_v</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">Variable</span>(<span style="color:#a6e22e">inputs</span>, <span style="color:#a6e22e">requires_grad</span><span style="color:#f92672">=</span><span style="color:#a6e22e">False</span>), <span style="color:#a6e22e">Variable</span>(<span style="color:#a6e22e">labels</span>, <span style="color:#a6e22e">requires_grad</span><span style="color:#f92672">=</span><span style="color:#a6e22e">False</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">y</span> <span style="color:#a6e22e">zero</span> <span style="color:#a6e22e">the</span> <span style="color:#a6e22e">parameter</span> <span style="color:#a6e22e">gradients</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">optimizer</span>.<span style="color:#a6e22e">zero_grad</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">forward</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">backward</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">optimize</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">d0</span>, <span style="color:#a6e22e">d1</span>, <span style="color:#a6e22e">d2</span>, <span style="color:#a6e22e">d3</span>, <span style="color:#a6e22e">d4</span>, <span style="color:#a6e22e">d5</span>, <span style="color:#a6e22e">d6</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">net</span>(<span style="color:#a6e22e">inputs_v</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">loss2</span>, <span style="color:#a6e22e">loss</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">muti_bce_loss_fusion</span>(<span style="color:#a6e22e">d0</span>, <span style="color:#a6e22e">d1</span>, <span style="color:#a6e22e">d2</span>, <span style="color:#a6e22e">d3</span>, <span style="color:#a6e22e">d4</span>, <span style="color:#a6e22e">d5</span>, <span style="color:#a6e22e">d6</span>, <span style="color:#a6e22e">labels_v</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">loss</span>.<span style="color:#a6e22e">backward</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">optimizer</span>.<span style="color:#a6e22e">step</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">print</span> <span style="color:#a6e22e">statistics</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">running_loss</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">loss</span>.<span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">item</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">running_tar_loss</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">loss2</span>.<span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">item</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">del</span> <span style="color:#a6e22e">temporary</span> <span style="color:#a6e22e">outputs</span> <span style="color:#a6e22e">and</span> <span style="color:#a6e22e">loss</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">del</span> <span style="color:#a6e22e">d0</span>, <span style="color:#a6e22e">d1</span>, <span style="color:#a6e22e">d2</span>, <span style="color:#a6e22e">d3</span>, <span style="color:#a6e22e">d4</span>, <span style="color:#a6e22e">d5</span>, <span style="color:#a6e22e">d6</span>, <span style="color:#a6e22e">loss2</span>, <span style="color:#a6e22e">loss</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">print</span>(<span style="color:#e6db74">&#34;[epoch: %3d/%3d, batch: %5d/%5d, ite: %d] train loss: %3f, tar: %3f &#34;</span> <span style="color:#f92672">%</span> (
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">epoch</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">epoch_num</span>, (<span style="color:#a6e22e">i</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">*</span> <span style="color:#a6e22e">batch_size_train</span>, <span style="color:#a6e22e">train_num</span>, <span style="color:#a6e22e">ite_num</span>, <span style="color:#a6e22e">running_loss</span> <span style="color:#f92672">/</span> <span style="color:#a6e22e">ite_num4val</span>, <span style="color:#a6e22e">running_tar_loss</span> <span style="color:#f92672">/</span> <span style="color:#a6e22e">ite_num4val</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ite_num</span> <span style="color:#f92672">%</span> <span style="color:#a6e22e">save_frq</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">torch</span>.<span style="color:#a6e22e">save</span>(<span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">state_dict</span>(), <span style="color:#a6e22e">model_dir</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">model_name</span><span style="color:#f92672">+</span><span style="color:#e6db74">&#34;_bce_itr_%d_train_%3f_tar_%3f.pth&#34;</span> <span style="color:#f92672">%</span> (<span style="color:#a6e22e">ite_num</span>, <span style="color:#a6e22e">running_loss</span> <span style="color:#f92672">/</span> <span style="color:#a6e22e">ite_num4val</span>, <span style="color:#a6e22e">running_tar_loss</span> <span style="color:#f92672">/</span> <span style="color:#a6e22e">ite_num4val</span>))
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">running_loss</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.0</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">running_tar_loss</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.0</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">train</span>()  <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">resume</span> <span style="color:#a6e22e">train</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">ite_num4val</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span></code></pre></div><h1 id="训练">训练</h1>
<p>python train_own.py 即可开始训练，不过感觉训练得有点慢，且官方库没有 resume这个功能</p>
<h1 id="测试">测试</h1>
<h2 id="inferpy">infer.py</h2>
<p>官方库测试的话出来最终只有mask图片，我根据提供的demo简单写了一个mask覆盖在原图的方法</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">cv2</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">torch</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">from</span> <span style="color:#a6e22e">model</span> <span style="color:#66d9ef">import</span> <span style="color:#a6e22e">U2NET</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">from</span> <span style="color:#a6e22e">torch</span>.<span style="color:#a6e22e">autograd</span> <span style="color:#66d9ef">import</span> <span style="color:#a6e22e">Variable</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">numpy</span> <span style="color:#a6e22e">as</span> <span style="color:#a6e22e">np</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">from</span> <span style="color:#a6e22e">glob</span> <span style="color:#66d9ef">import</span> <span style="color:#a6e22e">glob</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">os</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">from</span> <span style="color:#a6e22e">skimage</span> <span style="color:#66d9ef">import</span> <span style="color:#a6e22e">io</span>, <span style="color:#a6e22e">transform</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">from</span> <span style="color:#a6e22e">PIL</span> <span style="color:#66d9ef">import</span> <span style="color:#a6e22e">Image</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">def</span> <span style="color:#a6e22e">normPRED</span>(<span style="color:#a6e22e">d</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ma</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">torch</span>.<span style="color:#a6e22e">max</span>(<span style="color:#a6e22e">d</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">mi</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">torch</span>.<span style="color:#a6e22e">min</span>(<span style="color:#a6e22e">d</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">dn</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">d</span><span style="color:#f92672">-</span><span style="color:#a6e22e">mi</span>)<span style="color:#f92672">/</span>(<span style="color:#a6e22e">ma</span><span style="color:#f92672">-</span><span style="color:#a6e22e">mi</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">dn</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">def</span> <span style="color:#a6e22e">rescale_image</span>(<span style="color:#a6e22e">image</span>, <span style="color:#a6e22e">output_size</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">h</span>, <span style="color:#a6e22e">w</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">image</span>.<span style="color:#a6e22e">shape</span>[<span style="color:#f92672">:</span><span style="color:#ae81ff">2</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">isinstance</span>(<span style="color:#a6e22e">output_size</span>, <span style="color:#66d9ef">int</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">h</span> <span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">w</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">new_h</span>, <span style="color:#a6e22e">new_w</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">output_size</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">h</span> <span style="color:#f92672">/</span> <span style="color:#a6e22e">w</span>, <span style="color:#a6e22e">output_size</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">new_h</span>, <span style="color:#a6e22e">new_w</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">output_size</span>, <span style="color:#a6e22e">output_size</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">w</span> <span style="color:#f92672">/</span> <span style="color:#a6e22e">h</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">new_h</span>, <span style="color:#a6e22e">new_w</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">output_size</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">new_h</span>, <span style="color:#a6e22e">new_w</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">int</span>(<span style="color:#a6e22e">new_h</span>), <span style="color:#66d9ef">int</span>(<span style="color:#a6e22e">new_w</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">img</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">transform</span>.<span style="color:#a6e22e">resize</span>(<span style="color:#a6e22e">image</span>, (<span style="color:#a6e22e">output_size</span>, <span style="color:#a6e22e">output_size</span>), <span style="color:#a6e22e">mode</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;constant&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">img</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">def</span> <span style="color:#a6e22e">to_tensor</span>(<span style="color:#a6e22e">image</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">tmpImg</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">zeros</span>((<span style="color:#a6e22e">image</span>.<span style="color:#a6e22e">shape</span>[<span style="color:#ae81ff">0</span>],<span style="color:#a6e22e">image</span>.<span style="color:#a6e22e">shape</span>[<span style="color:#ae81ff">1</span>],<span style="color:#ae81ff">3</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">image</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">image</span> <span style="color:#f92672">/</span> <span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">max</span>(<span style="color:#a6e22e">image</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">image</span>.<span style="color:#a6e22e">shape</span>[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> (<span style="color:#a6e22e">image</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">0</span>] <span style="color:#f92672">-</span> <span style="color:#ae81ff">0.485</span>) <span style="color:#f92672">/</span> <span style="color:#ae81ff">0.229</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> (<span style="color:#a6e22e">image</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">0</span>] <span style="color:#f92672">-</span> <span style="color:#ae81ff">0.485</span>) <span style="color:#f92672">/</span> <span style="color:#ae81ff">0.229</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> (<span style="color:#a6e22e">image</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">0</span>] <span style="color:#f92672">-</span> <span style="color:#ae81ff">0.485</span>) <span style="color:#f92672">/</span> <span style="color:#ae81ff">0.229</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> (<span style="color:#a6e22e">image</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">0</span>] <span style="color:#f92672">-</span> <span style="color:#ae81ff">0.485</span>) <span style="color:#f92672">/</span> <span style="color:#ae81ff">0.229</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> (<span style="color:#a6e22e">image</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">1</span>] <span style="color:#f92672">-</span> <span style="color:#ae81ff">0.456</span>) <span style="color:#f92672">/</span> <span style="color:#ae81ff">0.224</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> (<span style="color:#a6e22e">image</span>[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">2</span>] <span style="color:#f92672">-</span> <span style="color:#ae81ff">0.406</span>) <span style="color:#f92672">/</span> <span style="color:#ae81ff">0.225</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">tmpImg</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">tmpImg</span>.<span style="color:#a6e22e">transpose</span>((<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">torch</span>.<span style="color:#a6e22e">from_numpy</span>(<span style="color:#a6e22e">tmpImg</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">def</span> <span style="color:#a6e22e">save_output_after</span>(<span style="color:#a6e22e">image_name</span>,<span style="color:#a6e22e">pred</span>,<span style="color:#a6e22e">d_dir</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">predict</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">pred</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">predict</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">predict</span>.<span style="color:#a6e22e">squeeze</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">predict_np</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">predict</span>.<span style="color:#a6e22e">cpu</span>().<span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">numpy</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">im</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">Image</span>.<span style="color:#a6e22e">fromarray</span>(<span style="color:#a6e22e">predict_np</span><span style="color:#f92672">*</span><span style="color:#ae81ff">255</span>).<span style="color:#a6e22e">convert</span>(<span style="color:#e6db74">&#39;RGB&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">img_name</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">image_name</span>.<span style="color:#a6e22e">split</span>(<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">sep</span>)[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">image</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">imread</span>(<span style="color:#a6e22e">image_name</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">imo</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">im</span>.<span style="color:#a6e22e">resize</span>((<span style="color:#a6e22e">image</span>.<span style="color:#a6e22e">shape</span>[<span style="color:#ae81ff">1</span>],<span style="color:#a6e22e">image</span>.<span style="color:#a6e22e">shape</span>[<span style="color:#ae81ff">0</span>]),<span style="color:#a6e22e">resample</span><span style="color:#f92672">=</span><span style="color:#a6e22e">Image</span>.<span style="color:#a6e22e">BILINEAR</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">pb_np</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">array</span>(<span style="color:#a6e22e">imo</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">print</span>(<span style="color:#e6db74">&#34;imagename:&#34;</span>,<span style="color:#a6e22e">image_name</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">aaa</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">img_name</span>.<span style="color:#a6e22e">split</span>(<span style="color:#e6db74">&#34;.&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">bbb</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">aaa</span>[<span style="color:#ae81ff">0</span><span style="color:#f92672">:-</span><span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">imidx</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">bbb</span>[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">range</span>(<span style="color:#ae81ff">1</span>,<span style="color:#a6e22e">len</span>(<span style="color:#a6e22e">bbb</span>))<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">imidx</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">imidx</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;.&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">bbb</span>[<span style="color:#a6e22e">i</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">imo</span>.<span style="color:#a6e22e">save</span>(<span style="color:#a6e22e">d_dir</span><span style="color:#f92672">+</span><span style="color:#a6e22e">imidx</span><span style="color:#f92672">+</span><span style="color:#e6db74">&#39;.png&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">def</span> <span style="color:#a6e22e">save_output_after_cv</span>(<span style="color:#a6e22e">image_name</span>, <span style="color:#a6e22e">pred</span>, <span style="color:#a6e22e">d_dir</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">predict</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">pred</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">predict</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">predict</span>.<span style="color:#a6e22e">squeeze</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">predict_np</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">predict</span>.<span style="color:#a6e22e">cpu</span>().<span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">numpy</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">Scale</span> <span style="color:#a6e22e">prediction</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">range</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">-</span><span style="color:#ae81ff">255</span> <span style="color:#a6e22e">and</span> <span style="color:#a6e22e">convert</span> <span style="color:#a6e22e">to</span> <span style="color:#ae81ff">3</span><span style="color:#f92672">-</span><span style="color:#a6e22e">channel</span> (<span style="color:#a6e22e">BGR</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">predict_np</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">cv2</span>.<span style="color:#a6e22e">cvtColor</span>((<span style="color:#a6e22e">predict_np</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">255</span>).<span style="color:#a6e22e">astype</span>(<span style="color:#e6db74">&#39;uint8&#39;</span>), <span style="color:#a6e22e">cv2</span>.<span style="color:#a6e22e">COLOR_GRAY2BGR</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">img_name</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">image_name</span>.<span style="color:#a6e22e">split</span>(<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">sep</span>)[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">image</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">cv2</span>.<span style="color:#a6e22e">imread</span>(<span style="color:#a6e22e">image_name</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">Resize</span> <span style="color:#a6e22e">the</span> <span style="color:#a6e22e">prediction</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">original</span> <span style="color:#a6e22e">image</span> <span style="color:#a6e22e">size</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">imo</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">cv2</span>.<span style="color:#a6e22e">resize</span>(<span style="color:#a6e22e">predict_np</span>, (<span style="color:#a6e22e">image</span>.<span style="color:#a6e22e">shape</span>[<span style="color:#ae81ff">1</span>], <span style="color:#a6e22e">image</span>.<span style="color:#a6e22e">shape</span>[<span style="color:#ae81ff">0</span>]), <span style="color:#a6e22e">interpolation</span><span style="color:#f92672">=</span><span style="color:#a6e22e">cv2</span>.<span style="color:#a6e22e">INTER_LINEAR</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ret</span>, <span style="color:#a6e22e">binary</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">cv2</span>.<span style="color:#a6e22e">threshold</span>(<span style="color:#a6e22e">imo</span>.<span style="color:#a6e22e">astype</span>(<span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">uint8</span>), <span style="color:#ae81ff">125</span>, <span style="color:#ae81ff">255</span>, <span style="color:#a6e22e">cv2</span>.<span style="color:#a6e22e">THRESH_BINARY</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">Normalize</span> <span style="color:#a6e22e">imo</span> <span style="color:#a6e22e">back</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">range</span> [<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">imo_normalized</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">imo</span>.<span style="color:#a6e22e">astype</span>(<span style="color:#e6db74">&#39;float&#39;</span>) <span style="color:#f92672">/</span> <span style="color:#ae81ff">255</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">mask</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">binary</span>.<span style="color:#a6e22e">astype</span>(<span style="color:#a6e22e">bool</span>)[<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">print</span>(<span style="color:#e6db74">&#34;mask:&#34;</span>,<span style="color:#a6e22e">mask</span>.<span style="color:#a6e22e">shape</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">color_mask</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">array</span>([[<span style="color:#ae81ff">128</span>, <span style="color:#ae81ff">64</span>, <span style="color:#ae81ff">128</span>]])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">image</span>[<span style="color:#a6e22e">mask</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">image</span>[<span style="color:#a6e22e">mask</span>] <span style="color:#f92672">*</span> <span style="color:#ae81ff">0.5</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">color_mask</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">0.5</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">print</span>(<span style="color:#e6db74">&#34;imagename:&#34;</span>, <span style="color:#a6e22e">image_name</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">aaa</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">img_name</span>.<span style="color:#a6e22e">split</span>(<span style="color:#e6db74">&#34;.&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">bbb</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">aaa</span>[<span style="color:#ae81ff">0</span><span style="color:#f92672">:-</span><span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">imidx</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">bbb</span>[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">range</span>(<span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">len</span>(<span style="color:#a6e22e">bbb</span>))<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">imidx</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">imidx</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;.&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">bbb</span>[<span style="color:#a6e22e">i</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">回显结果</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">cv2</span>.<span style="color:#a6e22e">imwrite</span>(<span style="color:#a6e22e">d_dir</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">imidx</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;.png&#39;</span>, <span style="color:#a6e22e">image</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">Save</span> <span style="color:#a6e22e">the</span> <span style="color:#a6e22e">image</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">cv2</span>.<span style="color:#a6e22e">imwrite</span>(<span style="color:#a6e22e">d_dir</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">imidx</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;_mask.png&#39;</span>, <span style="color:#a6e22e">imo</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">def</span> <span style="color:#a6e22e">inference</span>(<span style="color:#a6e22e">net</span>,<span style="color:#a6e22e">input</span>)<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">tmpImg</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">rescale_image</span>(<span style="color:#a6e22e">input</span>,(<span style="color:#ae81ff">320</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">print</span>(<span style="color:#e6db74">&#34;tmpImgResize:&#34;</span>,<span style="color:#a6e22e">tmpImg</span>.<span style="color:#a6e22e">shape</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">tmpImg</span> <span style="color:#f92672">=</span><span style="color:#a6e22e">to_tensor</span>(<span style="color:#a6e22e">tmpImg</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">tmpImg</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">tmpImg</span>[<span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">newaxis</span>, <span style="color:#f92672">:</span>, <span style="color:#f92672">:</span>, <span style="color:#f92672">:</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">tmpImg</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">tmpImg</span>.<span style="color:#a6e22e">type</span>(<span style="color:#a6e22e">torch</span>.<span style="color:#a6e22e">FloatTensor</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">print</span>(<span style="color:#e6db74">&#34;tmpImgtensor:&#34;</span>, <span style="color:#a6e22e">tmpImg</span>.<span style="color:#a6e22e">shape</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">normalize</span> <span style="color:#a6e22e">the</span> <span style="color:#a6e22e">input</span>
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">input</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">cv2</span>.<span style="color:#a6e22e">resize</span>(<span style="color:#a6e22e">input</span>, (<span style="color:#ae81ff">320</span>,<span style="color:#ae81ff">320</span>), <span style="color:#a6e22e">interpolation</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">cv2</span>.<span style="color:#a6e22e">INTER_AREA</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">rescale_image</span>(<span style="color:#a6e22e">input</span>,(<span style="color:#ae81ff">320</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">tmpImg</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">zeros</span>((<span style="color:#ae81ff">320</span>,<span style="color:#ae81ff">320</span>,<span style="color:#ae81ff">3</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">input</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">input</span><span style="color:#f92672">/</span><span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">max</span>(<span style="color:#a6e22e">input</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">#</span>
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">#</span>
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>, <span style="color:#f92672">:</span>, <span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> (<span style="color:#a6e22e">input</span>[<span style="color:#f92672">:</span>, <span style="color:#f92672">:</span>, <span style="color:#ae81ff">0</span>] <span style="color:#f92672">-</span> <span style="color:#ae81ff">0.485</span>) <span style="color:#f92672">/</span> <span style="color:#ae81ff">0.229</span>
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>, <span style="color:#f92672">:</span>, <span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> (<span style="color:#a6e22e">input</span>[<span style="color:#f92672">:</span>, <span style="color:#f92672">:</span>, <span style="color:#ae81ff">1</span>] <span style="color:#f92672">-</span> <span style="color:#ae81ff">0.456</span>) <span style="color:#f92672">/</span> <span style="color:#ae81ff">0.224</span>
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">tmpImg</span>[<span style="color:#f92672">:</span>, <span style="color:#f92672">:</span>, <span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> (<span style="color:#a6e22e">input</span>[<span style="color:#f92672">:</span>, <span style="color:#f92672">:</span>, <span style="color:#ae81ff">2</span>] <span style="color:#f92672">-</span> <span style="color:#ae81ff">0.406</span>) <span style="color:#f92672">/</span> <span style="color:#ae81ff">0.225</span>
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">#</span>
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">#</span>
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">convert</span> <span style="color:#a6e22e">BGR</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">RGB</span>
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">tmpImg</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">tmpImg</span>.<span style="color:#a6e22e">transpose</span>((<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">tmpImg</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">tmpImg</span>[<span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">newaxis</span>,<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">tmpImg</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">torch</span>.<span style="color:#a6e22e">from_numpy</span>(<span style="color:#a6e22e">tmpImg</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">#</span>
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">convert</span> <span style="color:#a6e22e">numpy</span> <span style="color:#a6e22e">array</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">torch</span> <span style="color:#a6e22e">tensor</span>
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">tmpImg</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">tmpImg</span>.<span style="color:#a6e22e">type</span>(<span style="color:#a6e22e">torch</span>.<span style="color:#a6e22e">FloatTensor</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">torch</span>.<span style="color:#a6e22e">cuda</span>.<span style="color:#a6e22e">is_available</span>()<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">tmpImg</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">Variable</span>(<span style="color:#a6e22e">tmpImg</span>.<span style="color:#a6e22e">cuda</span>())
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">tmpImg</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">Variable</span>(<span style="color:#a6e22e">tmpImg</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">inference</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">d1</span>,<span style="color:#a6e22e">d2</span>,<span style="color:#a6e22e">d3</span>,<span style="color:#a6e22e">d4</span>,<span style="color:#a6e22e">d5</span>,<span style="color:#a6e22e">d6</span>,<span style="color:#a6e22e">d7</span><span style="color:#f92672">=</span> <span style="color:#a6e22e">net</span>(<span style="color:#a6e22e">tmpImg</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">normalization</span>
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">pred</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1.0</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">d1</span>[<span style="color:#f92672">:</span>,<span style="color:#ae81ff">0</span>,<span style="color:#f92672">:</span>,<span style="color:#f92672">:</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">pred</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">d1</span>[<span style="color:#f92672">:</span>, <span style="color:#ae81ff">0</span>, <span style="color:#f92672">:</span>, <span style="color:#f92672">:</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">pred</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">normPRED</span>(<span style="color:#a6e22e">pred</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">convert</span> <span style="color:#a6e22e">torch</span> <span style="color:#a6e22e">tensor</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">numpy</span> <span style="color:#a6e22e">array</span>
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">pred</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">pred</span>.<span style="color:#a6e22e">squeeze</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">pred</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">pred</span>.<span style="color:#a6e22e">cpu</span>().<span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">numpy</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">del</span> <span style="color:#a6e22e">d1</span>,<span style="color:#a6e22e">d2</span>,<span style="color:#a6e22e">d3</span>,<span style="color:#a6e22e">d4</span>,<span style="color:#a6e22e">d5</span>,<span style="color:#a6e22e">d6</span>,<span style="color:#a6e22e">d7</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">pred</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">def</span> <span style="color:#a6e22e">main</span>()<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">im_list</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">glob</span>(<span style="color:#e6db74">&#39;/opt/algorithm_code/U-2-Net-master/test_data/test_waterZone_images/*&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">print</span>(<span style="color:#e6db74">&#34;Number of images: &#34;</span>, <span style="color:#a6e22e">len</span>(<span style="color:#a6e22e">im_list</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">out_dir</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;/opt/algorithm_code/U-2-Net-master/test_data/own_infer/&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">not</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">path</span>.<span style="color:#a6e22e">exists</span>(<span style="color:#a6e22e">out_dir</span>))<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">mkdir</span>(<span style="color:#a6e22e">out_dir</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">model_dir</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">r</span><span style="color:#e6db74">&#34;/opt/algorithm_code/U-2-Net-master/saved_models/u2net/u2net_bce_itr_34000_train_0.106161_tar_0.011368.pth&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">load</span> <span style="color:#a6e22e">u2net_portrait</span> <span style="color:#a6e22e">model</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">net</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">U2NET</span>(<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">load_state_dict</span>(<span style="color:#a6e22e">torch</span>.<span style="color:#a6e22e">load</span>(<span style="color:#a6e22e">model_dir</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">torch</span>.<span style="color:#a6e22e">cuda</span>.<span style="color:#a6e22e">is_available</span>()<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">cuda</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">net</span>.eval()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#66d9ef">do</span> <span style="color:#a6e22e">the</span> <span style="color:#a6e22e">inference</span> <span style="color:#a6e22e">one</span><span style="color:#f92672">-</span><span style="color:#a6e22e">by</span><span style="color:#f92672">-</span><span style="color:#a6e22e">one</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">range</span>(<span style="color:#ae81ff">0</span>,<span style="color:#a6e22e">len</span>(<span style="color:#a6e22e">im_list</span>))<span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">print</span>(<span style="color:#e6db74">&#34;--------------------------&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">print</span>(<span style="color:#e6db74">&#34;inferencing &#34;</span>, <span style="color:#a6e22e">i</span>, <span style="color:#e6db74">&#34;/&#34;</span>, <span style="color:#a6e22e">len</span>(<span style="color:#a6e22e">im_list</span>), <span style="color:#a6e22e">im_list</span>[<span style="color:#a6e22e">i</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">load</span> <span style="color:#a6e22e">each</span> <span style="color:#a6e22e">image</span>
</span></span><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">img</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">cv2</span>.<span style="color:#a6e22e">imread</span>(<span style="color:#a6e22e">im_list</span>[<span style="color:#a6e22e">i</span>])
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">img</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">imread</span>(<span style="color:#a6e22e">im_list</span>[<span style="color:#a6e22e">i</span>])
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">im_portrait</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">inference</span>(<span style="color:#a6e22e">net</span>,<span style="color:#a6e22e">img</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">save</span> <span style="color:#a6e22e">the</span> <span style="color:#a6e22e">output</span>
</span></span><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">cv2</span>.<span style="color:#a6e22e">imwrite</span>(<span style="color:#a6e22e">out_dir</span><span style="color:#f92672">+</span><span style="color:#e6db74">&#34;/&#34;</span><span style="color:#f92672">+</span><span style="color:#a6e22e">im_list</span>[<span style="color:#a6e22e">i</span>].<span style="color:#a6e22e">split</span>(<span style="color:#e6db74">&#39;/&#39;</span>)[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>][<span style="color:#ae81ff">0</span><span style="color:#f92672">:-</span><span style="color:#ae81ff">4</span>]<span style="color:#f92672">+</span><span style="color:#e6db74">&#39;.png&#39;</span>,(<span style="color:#a6e22e">im_portrait</span><span style="color:#f92672">*</span><span style="color:#ae81ff">255</span>).<span style="color:#a6e22e">astype</span>(<span style="color:#a6e22e">np</span>.<span style="color:#a6e22e">uint8</span>))
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">save_output_after_cv</span>(<span style="color:#a6e22e">im_list</span>[<span style="color:#a6e22e">i</span>], <span style="color:#a6e22e">im_portrait</span>, <span style="color:#a6e22e">out_dir</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">__name__</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">main</span>()
</span></span></code></pre></div><p>需要注意的时，我本来用opencv 进行预处理，但是效果没有skimage的好 （因为训练时候用的skimage库）
但是我拿到mask后，需要用opencv的方法进行处理，所以会看到我预处理用的skimage，保存图片时用的opencv</p>
<h1 id="最终测试效果">最终测试效果</h1>
<p><img src="/images/ai/U_2_Net_train/3.jpg" alt=""></p>

        </p>
        
    </div>

    <div class="prev-next">
        
    </div>
</div>

<aside class="post-toc">
    <nav id="toc">
        <nav id="TableOfContents">
  <ul>
    <li><a href="#git">Git</a></li>
    <li><a href="#数据集准备">数据集准备</a></li>
    <li><a href="#修改代码">修改代码</a>
      <ul>
        <li><a href="#第一个错">第一个错</a></li>
        <li><a href="#第二错">第二错</a></li>
        <li><a href="#修改后的文件代码如下">修改后的文件代码如下</a>
          <ul>
            <li><a href="#data_loaderpy">data_loader.py</a></li>
            <li><a href="#train_ownpy">train_own.py</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#训练">训练</a></li>
    <li><a href="#测试">测试</a>
      <ul>
        <li><a href="#inferpy">infer.py</a></li>
      </ul>
    </li>
    <li><a href="#最终测试效果">最终测试效果</a></li>
  </ul>
</nav>
    </nav>
</aside>



    

        </main><footer class="footer">
    
    

    
    <span>&copy; 2023 The Marauders</span>
    
    <span>
        Made with &#10084;&#65039; using <a target="_blank">xhikun</a>
    </span>
</footer>
</body>
</html>
